<head>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css" integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh" crossorigin="anonymous">
</head>

<script>

var active_form = "zaznam";

window.onload = function() {
    document.getElementById('Date').value = new Date().toJSON().slice(0,10);
    switchForms();
}

function onSuccess() {

    document.getElementById("statusbar").innerHTML= ""
        +'<label>Úspěšně odesláno. :)</label>'
    document.getElementById("statusbar").className = "alert alert-success";

    var start_km = document.getElementById('start_km').value = "";
    var cartype = document.getElementById('cartype').value = "";
    var km  = document.getElementById('km').value = "";
    var l = document.getElementById('l').value = "";

    var carname = document.getElementById('carname').value;
    if (carname) {
        carname = carname.toString().replace( /(<([^>]+)>)/ig, '?!');
        var x = document.getElementById("cartype");
        var option = document.createElement("option");
        option.text = carname; option.value = carname;
        x.add(option);
    }
    document.getElementById('carname').value = "";
}

function onFailure() {
    document.getElementById("statusbar").innerHTML="Chyba! Obnov stránku";
    document.getElementById("statusbar").className = "alert alert-danger";
}

function newZaznam(hard = 0) {

    var cartype = document.getElementById('cartype').value;
    var Date  = document.getElementById('Date').value;
    var km  = document.getElementById('km').value;
    var l = document.getElementById('l').value;
    var warningText = "";

    if (cartype == "Vyber uživatele") warningText += "\nNení vybrán uživatel";
    if (km.length == 0) warningText += "\nNejsou vyplněné kilometry";
    if (km > 1000000)   warningText += "\nKilometry jsou vyšší než milion";
    //if (km < google_lastKm) warningText += "\nKilometry jsou nižší než posledně";
    if (l.length == 0) warningText += "\nNejsou vyplněné litry";

    if (warningText.length != 0 && !hard) {alert(warningText); return; }

    document.getElementById("statusbar").innerHTML="Odesílám, čekej"
    document.getElementById("statusbar").className = "alert alert-warning";

    google.script.run
        .withSuccessHandler(onSuccess)
        .withFailureHandler(onFailure)
        .fillIn(cartype, Date, km, l);
}
function newCar(hard = 0) {

    var carname = document.getElementById('carname').value;
    var start_km = document.getElementById('start_km').value;
    var date = new Date().toJSON().slice(0,10);
    var warningText = "";

    carname = carname.toString().replace( /(<([^>]+)>)/ig, '?!');

    if (start_km.length == 0) warningText += "\nNejsou vyplněné kilometry";
    if (start_km > 1000000)   warningText += "\nKilometry jsou vyšší než milion";
    //if (start_km < google_lastKm) warningText += "\nKilometry jsou nižší než posledně";

    if (warningText.length != 0 && !hard) {alert(warningText); return; }

    document.getElementById("statusbar").innerHTML="Odesílám, čekej"
    document.getElementById("statusbar").className = "alert alert-warning";

    google.script.run
        .withSuccessHandler(onSuccess)
        .withFailureHandler(onFailure)
        .registerCar(date, start_km, carname);

}

function submitData(hard = 0) {

    switch (active_form) {
        case "zaznam":
            newZaznam(hard);
        break;
        case "pridat":
            newCar(hard);
        break;
    }
}

function switchForms(form = "zaznam") {

    active_form = form;

    switch (form) {
        case "zaznam":
            document.getElementById("form_zaznam").style.display = "block";
            document.getElementById("button_zaznam").className = "btn btn-success";
            document.getElementById("form_pridat").style.display =  "none";
            document.getElementById("button_pridat").className = "btn btn-secondary";
        break;
        case "pridat":
            document.getElementById("form_zaznam").style.display =  "none";
            document.getElementById("button_zaznam").className = "btn btn-secondary";
            document.getElementById("form_pridat").style.display = "block";
            document.getElementById("button_pridat").className = "btn btn-success";
        break;
    }



}

</script>

<body>

<div style="width: 350px; margin: auto;">
    <div class="alert alert-info" role="alert" id="statusbar" style="text-align: center;">Zapiš</div>

    <div class="btn-group" role="group" style="width: 100%">
        <button type="button" class="btn btn-success" onclick='switchForms("zaznam")' id="button_zaznam">Záznam</button>
        <button type="button" class="btn btn-secondary" onclick='switchForms("pridat")' id="button_pridat">Registrace</button>
    </div>

    <form id="form_zaznam" style="display: block;">

        <div class="input-group">
            <div class="input-group-prepend"><span class="input-group-text" style="width: 100px;">Auto</span></div>
            <select class="custom-select" id="cartype" style="width: 100%; text-align: center;">
                <option selected>Vyber uživatele</option>
                <script>
                    sheetsNames.forEach(element => document.write(
                        '<option value='+window.atob(element)+'>'+window.atob(element)+'</option>')
                    );
                </script>
            </select>
        </div>

        <div class="input-group">
            <div class="input-group-prepend"><span class="input-group-text" style="width: 100px">Kilometry</span></div>
            <input type="number" class="form-control" id="km" style="max-width: 250px">
        </div>

        <div class="input-group">
            <div class="input-group-prepend"><span class="input-group-text" style="width: 100px">Litry</span></div>
            <input type="number" class="form-control" id="l" style="max-width: 250px">
        </div>

        <div class="input-group">
            <div class="input-group-prepend">
                <span class="input-group-text" style="width: 100px">Datum</span>
            </div>
            <input type="date" class="form-control" id="Date" style="max-width: 250px; text-align: center;">
        </div>

        <div class="custom-control custom-switch" style="text-align: right; display: none;">
            <input type="checkbox" class="custom-control-input" id="full" checked>
            <label class="custom-control-label" for="full">Natankována plná nádrž</label>
        </div>

        <div class="btn-group" role="group" style="width: 100%">
            <button type="button" class="btn btn-primary" onclick='submitData()' >Uložit</button>
        </div>

    </form>
    <form id="form_pridat" style="display: none;">

        <div class="input-group">
            <div class="input-group-prepend"><span class="input-group-text" style="width: 100px">Název auta</span></div>
            <input type="text" class="form-control" id="carname" style="max-width: 250px">
        </div>

        <div class="input-group">
            <div class="input-group-prepend"><span class="input-group-text" style="width: 100px">Kilometry</span></div>
            <input type="number" class="form-control" id="start_km" style="max-width: 250px">
        </div>

        <div class="btn-group" role="group" style="width: 100%">
            <button type="button" class="btn btn-primary" onclick='submitData()' >Zaregistrovat</button>
        </div>

    </form>
</div>

</body>
